<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dettagli del Viaggio</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .container {
            margin-top: 20px;
        }
        .img-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .immagine-copertina {
            width: 300px;
            height: 200px;
            object-fit: cover;
            margin-bottom: 20px;
        }
        .immagini-viaggio img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .tag {
            display: inline-block;
            padding: 5px 10px;
            margin: 5px;
            background-color: lightblue;
            border-radius: 5px;
        }
    .creatore-section {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
    }
    .creatore-section img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        margin-right: 15px;
    }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="nomeViaggio">Nome del Viaggio</h1>
        <div class="creatore-section">
        	<img id="immagineCreatore" class="img-thumbnail" alt="Immagine profilo creatore">
        	<p><strong>Creatore:</strong> <span id="nomeCreatore"></span></p>
    	</div>
        <div class="row">
            <div class="col-md-6">
                <!-- Immagine copertina -->
                <img id="immagineCopertina" class="immagine-copertina" alt="Immagine Copertina">
            </div>
            <div class="col-md-6">
                <h3>Dettagli del Viaggio</h3>
                <p><strong>Luogo di Partenza:</strong> <span id="luogoPartenza"></span></p>
                <p><strong>Luogo di Arrivo:</strong> <span id="luogoArrivo"></span></p>
                <p><strong>Data di Partenza:</strong> <span id="dataPartenza"></span></p>
                <p><strong>Data di Ritorno:</strong> <span id="dataRitorno"></span></p>
                <p><strong>Prezzo:</strong> €<span id="prezzo"></span></p>
                <p><strong>Età Minima:</strong> <span id="etaMin"></span></p>
                <p><strong>Età Massima:</strong> <span id="etaMax"></span></p>
                <p><strong>Numero Partecipanti:</strong> Min. <span id="numPartMin"></span> / Max. <span id="numPartMax"></span></p>
            </div>
        </div>

        <!-- Sezione per le immagini del viaggio -->
        <h3>Immagini del Viaggio</h3>
        <div id="immaginiViaggio" class="row immagini-viaggio"></div>

        <!-- Sezione per i tag del viaggio -->
        <h3>Tag del Viaggio</h3>
        <div id="tagsViaggio"></div>

        <!-- Sezione per i partecipanti -->
        <h3>Partecipanti al Viaggio</h3>
        <ul id="listaPartecipanti" class="list-group"></ul>
        
        <form id="iscrivitiForm" method="POST">
    		<button type="submit" class="btn btn-primary">Iscriviti al viaggio</button>
		</form>

    </div>

<script>
    // Funzione per formattare le date
    function formatDate(dateString) {
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        const date = new Date(dateString);
        return date.toLocaleDateString('it-IT', options);
    }
    
    async function getViaggioIdFromSession() {
        try {
            const response = await fetch('/api/session/viaggio');
            if (!response.ok) {
                throw new Error('Errore durante il recupero del viaggioId dalla sessione');
            }
            const viaggioId = await response.json();
            console.log('Viaggio ID dalla sessione:', viaggioId);

            if (!viaggioId) {
                throw new Error('Viaggio ID non trovato nella sessione');
            }

            // Ora passiamo il viaggioId alla funzione per caricare i dettagli del viaggio
            caricaDettagliViaggio(viaggioId);
        } catch (error) {
            console.error('Errore:', error);
        }
    }

    // Funzione per caricare i dettagli del viaggio, ora con parametro viaggioId
    async function caricaDettagliViaggio(viaggioId) {
    	
    	console.log('Viaggio ID ricevuto: ', viaggioId);
    	
        const response = await fetch(`/viaggio/${viaggioId}`);
        if (!response.ok) {
            console.error('Errore nel caricamento del viaggio');
            return;
        }
        const viaggio = await response.json();

        // Mostra i dettagli del viaggio
        document.getElementById('nomeViaggio').textContent = viaggio.nome || "Nome non disponibile";
        document.getElementById('luogoPartenza').textContent = viaggio.luogoPartenza || "Non disponibile";
        document.getElementById('luogoArrivo').textContent = viaggio.luogoArrivo || "Non disponibile";
        document.getElementById('dataPartenza').textContent = formatDate(viaggio.dataPartenza) || "Data non disponibile";
        document.getElementById('dataRitorno').textContent = formatDate(viaggio.dataRitorno) || "Data non disponibile";
        document.getElementById('prezzo').textContent = viaggio.prezzo ? viaggio.prezzo.toFixed(2) : "Prezzo non disponibile";
        document.getElementById('etaMin').textContent = viaggio.etaMin || "N/A";
        document.getElementById('etaMax').textContent = viaggio.etaMax || "N/A";
        document.getElementById('numPartMin').textContent = viaggio.numPartMin || "N/A";
        document.getElementById('numPartMax').textContent = viaggio.numPartMax || "N/A";
        document.getElementById('nomeCreatore').textContent = `${viaggio.nomeCreatore} ${viaggio.cognomeCreatore}`;

        // Mostra l'immagine del profilo del creatore
        if (viaggio.immagineProfiloCreatore) {
            const immagineCreatore = document.getElementById('immagineCreatore');
            immagineCreatore.src = `data:image/jpeg;base64,${viaggio.immagineProfiloCreatore}`;
        }
        
        // Mostra l'immagine di copertina
        if (viaggio.immagineCopertina) {
            const copertinaImg = document.getElementById('immagineCopertina');
            copertinaImg.src = `data:image/jpeg;base64,${viaggio.immagineCopertina}`;
        }

        // Mostra le immagini del viaggio se esistono
        const immaginiViaggioDiv = document.getElementById('immaginiViaggio');
        if (viaggio.immagini && viaggio.immagini.length > 0) {
            viaggio.immagini.forEach(immagine => {
                const img = document.createElement('img');
                img.src = `data:image/jpeg;base64,${immagine}`;
                immaginiViaggioDiv.appendChild(img);
            });
        } else {
            console.log("Nessuna immagine disponibile per il viaggio.");
        }

     // Mostra i tag del viaggio
        const tagsViaggioDiv = document.getElementById('tagsViaggio');
        if (viaggio.tagDTOs && viaggio.tagDTOs.length > 0) {
            viaggio.tagDTOs.forEach(tag => {
                const tagElement = document.createElement('div');
                tagElement.className = 'tag';
                tagElement.textContent = tag.tipoTag; // Assumendo che ci sia il campo tipoTag
                tagsViaggioDiv.appendChild(tagElement);
            });
        } else {
            console.log("Nessun tag trovato per il viaggio con ID:", viaggio.viaggioId);
        }

        // Mostra i partecipanti del viaggio se esistono
        const listaPartecipanti = document.getElementById('listaPartecipanti');
        if (viaggio.partecipanti && viaggio.partecipanti.length > 0) {
            viaggio.partecipanti.forEach(partecipante => {
                const partecipanteItem = document.createElement('li');
                partecipanteItem.className = 'list-group-item';
                partecipanteItem.textContent = `${partecipante.nome} ${partecipante.cognome}`;
                listaPartecipanti.appendChild(partecipanteItem);
            });
        } else {
            console.log("Nessun partecipante disponibile per il viaggio.");
        }
    }
    
    function setFormAction(viaggioId) {
        const form = document.getElementById('iscrivitiForm');
        form.action = `/api/viaggi/iscriviti/${viaggioId}`;
    }

    async function iscrivitiAlViaggio(viaggioId) {
        setFormAction(viaggioId);
        try {
            const response = await fetch(`/api/viaggi/iscriviti/${viaggioId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                alert('Iscrizione avvenuta con successo!');
            } else {
                alert('Errore durante l\'iscrizione');
            }
        } catch (error) {
            console.error('Errore durante la richiesta:', error);
            alert('Si è verificato un errore');
        }
    }

    // Carica i dati del viaggio al caricamento della pagina
    getViaggioIdFromSession();
</script>
</body>
</html>