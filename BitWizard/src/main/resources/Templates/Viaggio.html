<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dettagli del Viaggio</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .container {
            margin-top: 20px;
        }
        .img-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .immagine-copertina {
            width: 300px;
            height: 200px;
            object-fit: cover;
            margin-bottom: 20px;
        }
        .immagini-viaggio img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .tag {
            display: inline-block;
            padding: 5px 10px;
            margin: 5px;
            background-color: lightblue;
            border-radius: 5px;
        }
    .creatore-section {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
    }
    .creatore-section img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        margin-right: 15px;
    }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="nomeViaggio">Nome del Viaggio</h1>
        <div class="creatore-section">
        	<img id="immagineCreatore" class="img-thumbnail" alt="Immagine profilo creatore">
        	<p><strong>Creatore:</strong> <span id="nomeCreatore"></span></p>
    	</div>
        <div class="row">
            <div class="col-md-6">
                <!-- Immagine copertina -->
                <img id="immagineCopertina" class="immagine-copertina" alt="Immagine Copertina">
            </div>
            <div class="col-md-6">
                <h3>Dettagli del Viaggio</h3>
                <p><strong>Luogo di Partenza:</strong> <span id="luogoPartenza"></span></p>
                <p><strong>Luogo di Arrivo:</strong> <span id="luogoArrivo"></span></p>
                <p><strong>Data di Partenza:</strong> <span id="dataPartenza"></span></p>
                <p><strong>Data di Ritorno:</strong> <span id="dataRitorno"></span></p>
                <p><strong>Prezzo:</strong> €<span id="prezzo"></span></p>
                <p><strong>Età Minima:</strong> <span id="etaMin"></span></p>
                <p><strong>Età Massima:</strong> <span id="etaMax"></span></p>
                <p><strong>Numero Partecipanti:</strong> Min. <span id="numPartMin"></span> / Max. <span id="numPartMax"></span></p>
            </div>
        </div>

        <!-- Sezione per le immagini del viaggio -->
        <h3>Immagini del Viaggio</h3>
        <div id="immaginiViaggio" class="row immagini-viaggio"></div>

        <!-- Sezione per i tag del viaggio -->
        <h3>Tag del Viaggio</h3>
        <div id="tagsViaggio"></div>

        <!-- Sezione per i partecipanti -->
        <h3>Partecipanti al Viaggio</h3>
        <ul id="listaPartecipanti" class="list-group"></ul>
        
        <form id="iscrivitiForm" method="POST">
    		<button id="iscrivitiBtn" type="submit" class="btn btn-primary">Iscriviti al viaggio</button>
    		<button id="annullaIscrizioneBtn" type="button" class="btn btn-secondary" style="display: none;">Annulla Iscrizione</button>
		</form>
		
		<form id="creatoreForm" method="POST">
		<!-- Pulsanti specifici per il creatore (inizialmente nascosti) -->
    		<div id="pulsantiCreatore" style="display: none;">
    			<button id="modificaBtn" class="btn btn-warning">Modifica Viaggio</button>
    			<button id="annullaBtn" class="btn btn-danger">Cancella Viaggio</button>
		</div>
		</form>
		
		<div id="ChatDelViaggio" style="display: none;">
			<h2>Chat del viaggio</h2>
        	<div id="messaggioContainer" class="row">
          	  <!-- Le card dei messaggi verranno inserite qui dinamicamente -->
       	 	</div>
        
        	<h2>Invia un nuovo messaggio</h2>
    			<form id="messaggioForm" enctype="multipart/form-data">
        		<label for="testo">Testo del messaggio:</label><br>
        		<input type="text" id="testo" name="testo" required><br><br>
        
        		<label for="immagine">Immagine del messaggio (opzionale):</label><br>
        		<input type="file" id="immagine" name="immagineMessaggio"><br><br>

        		<button type="submit">Invia Messaggio</button>
   			</form>
   		</div>

    <p id="result"></p>

    <script src="messaggio.js"></script>

    </div>

<script>
    const viaggioId = new URLSearchParams(window.location.search).get('viaggioId');
    
    console.log(viaggioId);

    // Funzione per formattare le date
    function formatDate(dateString) {
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        const date = new Date(dateString);
        return date.toLocaleDateString('it-IT', options);
    }

    function aggiornaDettagliViaggio(viaggio) {
        document.getElementById('nomeViaggio').textContent = viaggio.nome || "Nome non disponibile";
        document.getElementById('luogoPartenza').textContent = viaggio.luogoPartenza || "Non disponibile";
        document.getElementById('luogoArrivo').textContent = viaggio.luogoArrivo || "Non disponibile";
        document.getElementById('dataPartenza').textContent = formatDate(viaggio.dataPartenza) || "Data non disponibile";
        document.getElementById('dataRitorno').textContent = formatDate(viaggio.dataRitorno) || "Data non disponibile";
        document.getElementById('prezzo').textContent = viaggio.prezzo ? viaggio.prezzo.toFixed(2) : "Prezzo non disponibile";
        document.getElementById('etaMin').textContent = viaggio.etaMin || "N/A";
        document.getElementById('etaMax').textContent = viaggio.etaMax || "N/A";
        document.getElementById('numPartMin').textContent = viaggio.numPartMin || "N/A";
        document.getElementById('numPartMax').textContent = viaggio.numPartMax || "N/A";
        document.getElementById('nomeCreatore').textContent = `${viaggio.nomeCreatore} ${viaggio.cognomeCreatore}`;
    }
    
    async function caricaDettagliViaggio(viaggioId) {
        console.log('Viaggio ID ricevuto: ', viaggioId);
        
        // Effettua la richiesta al server per ottenere i dettagli del viaggio
        const response = await fetch(`/viaggio/${viaggioId}`);
        
        if (!response.ok) {
            console.error('Errore nel caricamento del viaggio');
            return;
        }

        const viaggio = await response.json();
        
        console.log('id creatore' + viaggio.creatoreId);
        
        bottoneIscrizioneViaggio(viaggioId, viaggio.creatoreId);
        
        // Mostra le immagini del viaggio
        const immaginiViaggioDiv = document.getElementById('immaginiViaggio');
        immaginiViaggioDiv.innerHTML = '';  // Pulisci eventuali contenuti precedenti
        if (viaggio.immagini && viaggio.immagini.length > 0) {
            viaggio.immagini.forEach(immagine => {
                const img = document.createElement('img');
                img.src = `data:image/jpeg;base64,${immagine}`;
                img.alt = 'Immagine del viaggio';
                img.className = 'img-fluid col-md-4';  // Aggiungi classi di stile se necessario
                immaginiViaggioDiv.appendChild(img);
            });
        } else {
            console.log("Nessuna immagine disponibile per il viaggio.");
        }

        // Mostra i tag del viaggio
        const tagsViaggioDiv = document.getElementById('tagsViaggio');
        tagsViaggioDiv.innerHTML = '';  // Pulisci eventuali contenuti precedenti
        if (viaggio.tagDTOs && viaggio.tagDTOs.length > 0) {
            viaggio.tagDTOs.forEach(tag => {
                const tagElement = document.createElement('div');
                tagElement.className = 'badge badge-primary';  // Aggiungi classi di stile se necessario
                tagElement.textContent = tag.tipoTag;
                tagsViaggioDiv.appendChild(tagElement);
            });
        } else {
            console.log("Nessun tag trovato per il viaggio con ID:", viaggio.viaggioId);
        }

        // Mostra i partecipanti del viaggio
        const listaPartecipanti = document.getElementById('listaPartecipanti');
        listaPartecipanti.innerHTML = '';  // Pulisci eventuali contenuti precedenti
        if (viaggio.partecipanti && viaggio.partecipanti.length > 0) {
            viaggio.partecipanti.forEach(partecipante => {
                const partecipanteItem = document.createElement('li');
                partecipanteItem.className = 'list-group-item';
                partecipanteItem.textContent = `${partecipante.nome} ${partecipante.cognome}`;
                listaPartecipanti.appendChild(partecipanteItem);
            });
        } else {
            console.log("Nessun partecipante disponibile per il viaggio.");
        }

        // Mostra l'immagine di copertina
        const copertinaImg = document.getElementById('immagineCopertina');
        if (viaggio.immagineCopertina) {
            copertinaImg.src = `data:image/jpeg;base64,${viaggio.immagineCopertina}`;
            copertinaImg.alt = 'Copertina del viaggio';
        } else {
            console.log("Nessuna immagine di copertina trovata.");
        }

        // Mostra l'immagine del creatore
        const immagineCreatore = document.getElementById('immagineCreatore');
        if (viaggio.immagineProfiloCreatore) {
            immagineCreatore.src = `data:image/jpeg;base64,${viaggio.immagineProfiloCreatore}`;
            immagineCreatore.alt = 'Immagine profilo del creatore';
        } else {
            console.log("Nessuna immagine del creatore trovata.");
        }

        // Mostra il nome del creatore
        document.getElementById('nomeCreatore').textContent = `${viaggio.nomeCreatore} ${viaggio.cognomeCreatore}`;
        
        aggiornaDettagliViaggio(viaggio);
    }
    
    async function aggiornaPartecipanti(viaggioId) {
        try {
            // Effettua la richiesta per ottenere la lista aggiornata dei partecipanti
            const response = await fetch(`/viaggio/${viaggioId}/partecipanti`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                const partecipanti = await response.json();

                // Pulisci la lista dei partecipanti nel DOM
                const listaPartecipanti = document.getElementById('listaPartecipanti');
                listaPartecipanti.innerHTML = '';  // Rimuove i partecipanti precedenti

                if (partecipanti && partecipanti.length > 0) {
                    // Aggiungi i nuovi partecipanti
                    partecipanti.forEach(partecipante => {
                        const partecipanteItem = document.createElement('li');
                        partecipanteItem.className = 'list-group-item';
                        partecipanteItem.textContent = `${partecipante.nome} ${partecipante.cognome}`;
                        listaPartecipanti.appendChild(partecipanteItem);
                    });
                } else {
                    console.log("Nessun partecipante disponibile per il viaggio.");
                }
            } else {
                console.error("Errore nel caricamento dei partecipanti.");
            }
        } catch (error) {
            console.error("Errore durante la richiesta:", error);
        }
    }

    function setFormAction(viaggioId) {
        const form = document.getElementById('iscrivitiForm');
        form.action = `/api/viaggi/iscriviti/${viaggioId}`;
    }

    async function iscrivitiAlViaggio(viaggioId) {
        setFormAction(viaggioId);
        console.log('Id viaggio inviato per l iscrizione: ' + viaggioId);
        try {
            const response = await fetch(`/api/viaggi/iscriviti/${viaggioId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
            	aggiornaPartecipanti(viaggioId);
                alert('Iscrizione avvenuta con successo!');     
            } else {
                alert('Errore durante l\'iscrizione');
            }
        } catch (error) {
            console.error('Errore durante la richiesta:', error);
            alert('Si è verificato un errore');
        }
    }

    // Aggiungi l'evento al form solo dopo che il viaggioId è stato recuperato
    document.getElementById('iscrivitiForm').addEventListener('submit', function(event) {
        event.preventDefault();  // Evita il submit del form nativo
        if (viaggioId) {
            iscrivitiAlViaggio(viaggioId);
        } else {
            console.error('Errore: Viaggio ID non disponibile.');
        }
    });
    
    async function annullaViaggio(viaggioId) {
        setFormAction(viaggioId);
        console.log('Id viaggio inviato per l annullamento: ' + viaggioId);
        try {
            const response = await fetch(`/api/viaggi/annulla/${viaggioId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
            	aggiornaPartecipanti(viaggioId);
                alert('Annullamento avvenuta con successo!');     
            } else {
                alert('Errore durante l\'annullamento');
            }
        } catch (error) {
            console.error('Errore durante la richiesta:', error);
            alert('Si è verificato un errore');
        }
    }
    
    async function modificaViaggio(viaggioId) {
        setFormAction(viaggioId);
        console.log('Id viaggio inviato per l annullamento: ' + viaggioId);
        try {
            const response = await fetch(`/api/viaggi/modifica/${viaggioId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
            	aggiornaPartecipanti(viaggioId);
                alert('Annullamento avvenuta con successo!');     
            } else {
                alert('Errore durante l\'annullamento');
            }
        } catch (error) {
            console.error('Errore durante la richiesta:', error);
            alert('Si è verificato un errore');
        }
    }
    
        // Aggiungi l'evento per il pulsante di modifica
        document.getElementById('modificaBtn').addEventListener('click', function(event) {
            event.preventDefault(); // Evita il comportamento predefinito del form
            if (viaggioId) {
                modificaViaggio(viaggioId); // Funzione per modificare il viaggio
            } else {
                console.error('Errore: Viaggio ID non disponibile per la modifica.');
            }
        });

        // Aggiungi l'evento per il pulsante di annullamento
        document.getElementById('annullaBtn').addEventListener('click', function(event) {
            event.preventDefault(); // Evita il comportamento predefinito del form
            if (viaggioId) {
                annullaViaggio(viaggioId); // Funzione per annullare il viaggio
            } else {
                console.error('Errore: Viaggio ID non disponibile per l\'annullamento.');
            }
        });

    // Carica i dettagli del viaggio quando la pagina viene caricata
    if (viaggioId) {
        caricaDettagliViaggio(viaggioId);  // Chiamata per caricare i dettagli del viaggio
    } else {
        console.error('Errore: Viaggio ID non disponibile.');
    }
    
    async function bottoneIscrizioneViaggio(viaggioId, creatoreId) {
    	console.log('viaggioId ricevuto da aggiorna bottone ' + viaggioId);
        try {
            // Effettua la richiesta al server per ottenere l'ID dell'utente loggato
            const response = await fetch(`/api/utente/session`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                const utenteLoggato = await response.json();  // Ottieni l'ID dell'utente loggato dal server

                console.log('ID utente loggato:', utenteLoggato);
                console.log('ID creatore del viaggio:', creatoreId);

                // Confronta gli ID convertendo entrambi in numeri (se necessario)
                if (parseInt(utenteLoggato) === parseInt(creatoreId)) {
                    // Nascondi il pulsante di iscrizione se l'utente è il creatore
                    document.getElementById('iscrivitiBtn').style.display = 'none';

                    // Mostra i pulsanti del creatore
                    document.getElementById('pulsantiCreatore').style.display = 'block';
                } else {
                	
                    // Mostra il pulsante di iscrizione se l'utente non è il creatore
                    document.getElementById('iscrivitiBtn').style.display = 'block';
                    // Nascondi i pulsanti del creatore
                    document.getElementById('pulsantiCreatore').style.display = 'none';
                    console.log('controllo iscrizione con viaggioId:', viaggioId);
                    // Passa correttamente viaggioId alla funzione verificaIscrizioneUtente
                    verificaIscrizioneUtente(viaggioId, utenteLoggato);
                }
            } else {
                console.error('Errore nel recupero della sessione utente');
            }
        } catch (error) {
            console.error('Errore durante la richiesta:', error);
        }
    }
    
    async function verificaIscrizioneUtente(viaggioId, utenteLoggato) {
        try {
            const response = await fetch(`/viaggio/${viaggioId}/partecipanti`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                const partecipanti = await response.json();
                
                // Aggiungi un log per vedere i dati dei partecipanti
                console.log('Partecipanti ricevuti:', partecipanti);
                console.log('Utente loggato:', utenteLoggato);

                // Confronta gli ID convertendoli in numeri
                const isUtenteIscritto = partecipanti.some(partecipante => parseInt(partecipante.utenteId) === parseInt(utenteLoggato));

                if (isUtenteIscritto) {
                    console.log('Utente iscritto');
                    document.getElementById('iscrivitiBtn').style.display = 'none';
                    document.getElementById('annullaIscrizioneBtn').style.display = 'block';
                    document.getElementById('ChatDelViaggio').style.display = 'block';
                } else {
                    console.log('Utente non iscritto');
                    document.getElementById('iscrivitiBtn').style.display = 'block';
                    document.getElementById('annullaIscrizioneBtn').style.display = 'none';
                    document.getElementById('ChatDelViaggio').style.display = 'none';
                }
            } else {
                console.error('Errore nel caricamento dei partecipanti.');
            }
        } catch (error) {
            console.error('Errore durante la richiesta:', error);
        }
    }
    
 // Funzione per caricare i messaggi di un viaggio specifico
    async function caricaMessaggio(viaggioId) {
        // Usa backtick per interpolare correttamente il viaggioId nell'URL
        const response = await fetch(`/carica/messaggi/${viaggioId}`); // Correzione dell'URL
        const messaggi = await response.json();
        const container = document.getElementById('messaggioContainer');

        // Azzera il contenuto del container prima di caricare i nuovi messaggi
        container.innerHTML = '';

        // Usa for...of per iterare sugli oggetti asincroni
        for (let messaggio of messaggi) {
            const messaggioCard = await createMessaggioCard(messaggio);  // Attendi che la card venga creata
            container.innerHTML += messaggioCard;  // Aggiungi la card al container
        }
    }

    // Funzione per creare una card di Bootstrap per un messaggio
    async function createMessaggioCard(messaggio) {
        // Formatta la data in maniera più leggibile (es. dd/mm/yyyy)
        const dataInvio = new Date(messaggio.data).toLocaleString('it-IT', {
    		day: '2-digit',
    		month: '2-digit',
    		year: 'numeric',
    		hour: '2-digit',
    		minute: '2-digit',
		});
        
        let utenteNome = 'Anonimo';  // Default se non troviamo l'utente

        // Se utenteId esiste, fai una chiamata per ottenere i dettagli dell'utente
        if (messaggio.utenteId) {
            try {
                // Correggi l'interpolazione dell'URL con i backtick
                const response = await fetch(`/messaggio/utente/nome/${messaggio.utenteId}`);
                const utente = await response.json();
                utenteNome = utente.nome ? utente.nome : 'Anonimo';  // Verifica se l'utente ha un nome
                utenteCognome = utente.cognome ? utente.cognome : '';  // Verifica se l'utente ha un cognome
            } catch (error) {
                console.error('Errore nel recupero dei dati dell\'utente', error);
            }
        }

        // Crea la card HTML per il messaggio
        return `
            <div class="col-md-4">
                <div class="card mb-4">
                <img src="/api/immagini/utente/profilo/${messaggio.utenteId}" class="card-img-top" alt="Immagine profilo utente">
                    <div class="card-body">
                    <h5 class="card-title">${utenteNome} ${utenteCognome}</h5>
                        <p class="card-text">
                            ${messaggio.testo} <br>
                            Data: ${dataInvio} <br>
                        </p>
                    </div>
                </div>
            </div>
        `;
    }
 
 	caricaMessaggio(viaggioId);
 	
 	document.getElementById('messaggioForm').addEventListener('submit', async function(event) {
 	    event.preventDefault();  // Previene il comportamento predefinito del form (il refresh della pagina)

 	    const form = document.getElementById('messaggioForm');
 	    const formData = new FormData(form);

 	    // Dati del messaggio
 	    const messaggioDTO = {
 	        testo: formData.get('testo'),
 	        viaggioId: viaggioId
 	    };

 	    // Aggiungi messaggioDTO come JSON nel FormData
 	    formData.append('messaggioDTO', new Blob([JSON.stringify(messaggioDTO)], {
 	        type: 'application/json'
 	    }));

 	    try {
 	        const response = await fetch('/crea/messaggio', {
 	            method: 'POST',
 	            body: formData
 	        });

 	        const result = await response.json();
 	        if (response.ok) {
 	            document.getElementById('result').innerText = 'Messaggio inviato con successo!';
 	        } else {
 	            document.getElementById('result').innerText = 'Errore: ' + result.error;
 	        }
 	    } catch (error) {
 	        document.getElementById('result').innerText = 'Errore nella richiesta: ' + error;
 	    }
 	});

</script>

</body>
</html>