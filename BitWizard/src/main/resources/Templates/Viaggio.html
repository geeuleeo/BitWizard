<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dettagli del Viaggio</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .container {
            margin-top: 20px;
        }
        .img-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .immagine-copertina {
            width: 300px;
            height: 200px;
            object-fit: cover;
            margin-bottom: 20px;
        }
        .immagini-viaggio img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .tag {
            display: inline-block;
            padding: 5px 10px;
            margin: 5px;
            background-color: lightblue;
            border-radius: 5px;
        }
    .creatore-section {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
    }
    .creatore-section img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        margin-right: 15px;
    }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="nomeViaggio">Nome del Viaggio</h1>
        <div class="creatore-section">
        	<img id="immagineCreatore" class="img-thumbnail" alt="Immagine profilo creatore">
        	<p><strong>Creatore:</strong> <span id="nomeCreatore"></span></p>
    	</div>
        <div class="row">
            <div class="col-md-6">
                <!-- Immagine copertina -->
                <img id="immagineCopertina" class="immagine-copertina" alt="Immagine Copertina">
            </div>
            <div class="col-md-6">
                <h3>Dettagli del Viaggio</h3>
                <p><strong>Luogo di Partenza:</strong> <span id="luogoPartenza"></span></p>
                <p><strong>Luogo di Arrivo:</strong> <span id="luogoArrivo"></span></p>
                <p><strong>Data di Partenza:</strong> <span id="dataPartenza"></span></p>
                <p><strong>Data di Ritorno:</strong> <span id="dataRitorno"></span></p>
                <p><strong>Prezzo:</strong> €<span id="prezzo"></span></p>
                <p><strong>Età Minima:</strong> <span id="etaMin"></span></p>
                <p><strong>Età Massima:</strong> <span id="etaMax"></span></p>
                <p><strong>Numero Partecipanti:</strong> Min. <span id="numPartMin"></span> / Max. <span id="numPartMax"></span></p>
            </div>
        </div>

        <!-- Sezione per le immagini del viaggio -->
        <h3>Immagini del Viaggio</h3>
        <div id="immaginiViaggio" class="row immagini-viaggio"></div>

        <!-- Sezione per i tag del viaggio -->
        <h3>Tag del Viaggio</h3>
        <div id="tagsViaggio"></div>

        <!-- Sezione per i partecipanti -->
        <h3>Partecipanti al Viaggio</h3>
        <ul id="listaPartecipanti" class="list-group"></ul>
        
        <form id="iscrivitiForm" method="POST">
    		<button id="iscrivitiBtn" type="submit" class="btn btn-primary">Iscriviti al viaggio</button>
		</form>

		<!-- Pulsanti specifici per il creatore (inizialmente nascosti) -->
		<div id="pulsantiCreatore" style="display: none;">
    		<button class="btn btn-warning">Modifica Viaggio</button>
    		<button class="btn btn-danger">Cancella Viaggio</button>
		</div>

    </div>

<script>
    const viaggioId = new URLSearchParams(window.location.search).get('viaggioId');
    
    console.log(viaggioId);

    // Funzione per formattare le date
    function formatDate(dateString) {
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        const date = new Date(dateString);
        return date.toLocaleDateString('it-IT', options);
    }

    function aggiornaDettagliViaggio(viaggio) {
        document.getElementById('nomeViaggio').textContent = viaggio.nome || "Nome non disponibile";
        document.getElementById('luogoPartenza').textContent = viaggio.luogoPartenza || "Non disponibile";
        document.getElementById('luogoArrivo').textContent = viaggio.luogoArrivo || "Non disponibile";
        document.getElementById('dataPartenza').textContent = formatDate(viaggio.dataPartenza) || "Data non disponibile";
        document.getElementById('dataRitorno').textContent = formatDate(viaggio.dataRitorno) || "Data non disponibile";
        document.getElementById('prezzo').textContent = viaggio.prezzo ? viaggio.prezzo.toFixed(2) : "Prezzo non disponibile";
        document.getElementById('etaMin').textContent = viaggio.etaMin || "N/A";
        document.getElementById('etaMax').textContent = viaggio.etaMax || "N/A";
        document.getElementById('numPartMin').textContent = viaggio.numPartMin || "N/A";
        document.getElementById('numPartMax').textContent = viaggio.numPartMax || "N/A";
        document.getElementById('nomeCreatore').textContent = `${viaggio.nomeCreatore} ${viaggio.cognomeCreatore}`;
    }
    
    async function caricaDettagliViaggio(viaggioId) {
        console.log('Viaggio ID ricevuto: ', viaggioId);
        
        // Effettua la richiesta al server per ottenere i dettagli del viaggio
        const response = await fetch(`/viaggio/${viaggioId}`);
        
        if (!response.ok) {
            console.error('Errore nel caricamento del viaggio');
            return;
        }

        const viaggio = await response.json();
        
        console.log('id creatore' + viaggio.creatoreId);
        
        bottoneIscrizioneViaggio(viaggio.creatoreId);
        
        // Mostra le immagini del viaggio
        const immaginiViaggioDiv = document.getElementById('immaginiViaggio');
        immaginiViaggioDiv.innerHTML = '';  // Pulisci eventuali contenuti precedenti
        if (viaggio.immagini && viaggio.immagini.length > 0) {
            viaggio.immagini.forEach(immagine => {
                const img = document.createElement('img');
                img.src = `data:image/jpeg;base64,${immagine}`;
                img.alt = 'Immagine del viaggio';
                img.className = 'img-fluid col-md-4';  // Aggiungi classi di stile se necessario
                immaginiViaggioDiv.appendChild(img);
            });
        } else {
            console.log("Nessuna immagine disponibile per il viaggio.");
        }

        // Mostra i tag del viaggio
        const tagsViaggioDiv = document.getElementById('tagsViaggio');
        tagsViaggioDiv.innerHTML = '';  // Pulisci eventuali contenuti precedenti
        if (viaggio.tagDTOs && viaggio.tagDTOs.length > 0) {
            viaggio.tagDTOs.forEach(tag => {
                const tagElement = document.createElement('div');
                tagElement.className = 'badge badge-primary';  // Aggiungi classi di stile se necessario
                tagElement.textContent = tag.tipoTag;
                tagsViaggioDiv.appendChild(tagElement);
            });
        } else {
            console.log("Nessun tag trovato per il viaggio con ID:", viaggio.viaggioId);
        }

        // Mostra i partecipanti del viaggio
        const listaPartecipanti = document.getElementById('listaPartecipanti');
        listaPartecipanti.innerHTML = '';  // Pulisci eventuali contenuti precedenti
        if (viaggio.partecipanti && viaggio.partecipanti.length > 0) {
            viaggio.partecipanti.forEach(partecipante => {
                const partecipanteItem = document.createElement('li');
                partecipanteItem.className = 'list-group-item';
                partecipanteItem.textContent = `${partecipante.nome} ${partecipante.cognome}`;
                listaPartecipanti.appendChild(partecipanteItem);
            });
        } else {
            console.log("Nessun partecipante disponibile per il viaggio.");
        }

        // Mostra l'immagine di copertina
        const copertinaImg = document.getElementById('immagineCopertina');
        if (viaggio.immagineCopertina) {
            copertinaImg.src = `data:image/jpeg;base64,${viaggio.immagineCopertina}`;
            copertinaImg.alt = 'Copertina del viaggio';
        } else {
            console.log("Nessuna immagine di copertina trovata.");
        }

        // Mostra l'immagine del creatore
        const immagineCreatore = document.getElementById('immagineCreatore');
        if (viaggio.immagineProfiloCreatore) {
            immagineCreatore.src = `data:image/jpeg;base64,${viaggio.immagineProfiloCreatore}`;
            immagineCreatore.alt = 'Immagine profilo del creatore';
        } else {
            console.log("Nessuna immagine del creatore trovata.");
        }

        // Mostra il nome del creatore
        document.getElementById('nomeCreatore').textContent = `${viaggio.nomeCreatore} ${viaggio.cognomeCreatore}`;
        
        aggiornaDettagliViaggio(viaggio);
    }
    
    async function aggiornaPartecipanti(viaggioId) {
        try {
            // Effettua la richiesta per ottenere la lista aggiornata dei partecipanti
            const response = await fetch(`/viaggio/${viaggioId}/partecipanti`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                const partecipanti = await response.json();

                // Pulisci la lista dei partecipanti nel DOM
                const listaPartecipanti = document.getElementById('listaPartecipanti');
                listaPartecipanti.innerHTML = '';  // Rimuove i partecipanti precedenti

                if (partecipanti && partecipanti.length > 0) {
                    // Aggiungi i nuovi partecipanti
                    partecipanti.forEach(partecipante => {
                        const partecipanteItem = document.createElement('li');
                        partecipanteItem.className = 'list-group-item';
                        partecipanteItem.textContent = `${partecipante.nome} ${partecipante.cognome}`;
                        listaPartecipanti.appendChild(partecipanteItem);
                    });
                } else {
                    console.log("Nessun partecipante disponibile per il viaggio.");
                }
            } else {
                console.error("Errore nel caricamento dei partecipanti.");
            }
        } catch (error) {
            console.error("Errore durante la richiesta:", error);
        }
    }

    function setFormAction(viaggioId) {
        const form = document.getElementById('iscrivitiForm');
        form.action = `/api/viaggi/iscriviti/${viaggioId}`;
    }

    async function iscrivitiAlViaggio(viaggioId) {
        setFormAction(viaggioId);
        console.log('Id viaggio inviato per l iscrizione: ' + viaggioId);
        try {
            const response = await fetch(`/api/viaggi/iscriviti/${viaggioId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
            	aggiornaPartecipanti(viaggioId);
                alert('Iscrizione avvenuta con successo!');     
            } else {
                alert('Errore durante l\'iscrizione');
            }
        } catch (error) {
            console.error('Errore durante la richiesta:', error);
            alert('Si è verificato un errore');
        }
    }

    // Aggiungi l'evento al form solo dopo che il viaggioId è stato recuperato
    document.getElementById('iscrivitiForm').addEventListener('submit', function(event) {
        event.preventDefault();  // Evita il submit del form nativo
        if (viaggioId) {
            iscrivitiAlViaggio(viaggioId);
        } else {
            console.error('Errore: Viaggio ID non disponibile.');
        }
    });

    // Carica i dettagli del viaggio quando la pagina viene caricata
    if (viaggioId) {
        caricaDettagliViaggio(viaggioId);  // Chiamata per caricare i dettagli del viaggio
    } else {
        console.error('Errore: Viaggio ID non disponibile.');
    }
    
    async function bottoneIscrizioneViaggio(creatoreId) {
        try {
            // Effettua la richiesta al server per ottenere l'ID dell'utente loggato
            const response = await fetch(`/api/utente/session`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                const utenteLoggato = await response.json();  // Ottieni l'ID dell'utente loggato dal server

                console.log('ID utente loggato:', utenteLoggato);
                console.log('ID creatore del viaggio:', creatoreId);

                // Confronta gli ID convertendo entrambi in numeri (se necessario)
                if (parseInt(utenteLoggato) === parseInt(creatoreId)) {
                    // Nascondi il pulsante di iscrizione se l'utente è il creatore
                    document.getElementById('iscrivitiBtn').style.display = 'none';

                    // Mostra i pulsanti del creatore
                    document.getElementById('pulsantiCreatore').style.display = 'block';
                } else {
                    // Mostra il pulsante di iscrizione se l'utente non è il creatore
                    document.getElementById('iscrivitiBtn').style.display = 'block';

                    // Nascondi i pulsanti del creatore
                    document.getElementById('pulsantiCreatore').style.display = 'none';
                }
            } else {
                console.error('Errore nel recupero della sessione utente');
            }
        } catch (error) {
            console.error('Errore durante la richiesta:', error);
        }
    }

</script>

</body>
</html>