<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creazione Viaggio</title>
    <script>
        // Funzione per ottenere i tag dal backend
        async function getTags() {
            const response = await fetch('/api/tags/cerca');
            const tags = await response.json();
            console.log("Tag ricevuti dal backend:", tags);
            return tags;
        }

        // Visualizza i tag disponibili
        function displayTags(tags) {
            const availableTagsDiv = document.getElementById('availableTags');
            tags.forEach(tag => {
                console.log("Tag caricato:", tag);
                const tagElement = document.createElement('div');
                tagElement.textContent = tag.tipoTag;
                tagElement.className = 'tag';
                tagElement.setAttribute('data-tag-id', tag.tagId);
                tagElement.onclick = () => selectTag(tagElement);
                availableTagsDiv.appendChild(tagElement);
            });
        }

        // Funzione per selezionare e rimuovere tag
        function selectTag(tagElement) {
            console.log("Tag selezionato:", tagElement);
            const selectedTagsDiv = document.getElementById('selectedTags');
            const clonedTag = tagElement.cloneNode(true);
            clonedTag.onclick = () => removeTag(clonedTag);
            selectedTagsDiv.appendChild(clonedTag);
            tagElement.remove();
        }

        function removeTag(tagElement) {
            console.log("Tag rimosso:", tagElement);
            const availableTagsDiv = document.getElementById('availableTags');
            const clonedTag = tagElement.cloneNode(true);
            clonedTag.onclick = () => selectTag(clonedTag);
            availableTagsDiv.appendChild(clonedTag);
            tagElement.remove();
        }

        // Aggiungi i tag selezionati al FormData
        function appendTagsToFormData(formData) {
            const selectedTagsDiv = document.getElementById('selectedTags');
            const tagElements = selectedTagsDiv.getElementsByClassName('tag');
            for (let i = 0; i < tagElements.length; i++) {
                const tagElement = tagElements[i];
                const tagId = tagElement.getAttribute('data-tag-id');
                const tagName = tagElement.textContent;
                if (tagId && tagName) {
                    formData.append(`tags[${i}][tagId]`, tagId);
                    formData.append(`tags[${i}][tipoTag]`, tagName);
                }
            }
        }
        
        // Funzione per l'anteprima dell'immagine di copertina
        function handleCopertinaImage() {
            const copertinaInput = document.getElementById('immagineCopertina');
            const copertinaPreview = document.getElementById('copertinaPreview');
            copertinaPreview.innerHTML = ""; // Pulizia dell'anteprima precedente

            if (copertinaInput.files && copertinaInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'img-preview';
                    copertinaPreview.appendChild(img);
                };
                reader.readAsDataURL(copertinaInput.files[0]);
            }
        }

        // Funzione per l'anteprima delle immagini multiple
        function handleMultipleImages() {
            const imageInput = document.getElementById('immagini');
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.innerHTML = ""; // Pulizia dell'anteprima precedente

            Array.from(imageInput.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'img-preview';
                    previewContainer.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }

        // Funzione per inviare il form
        function inviaForm() {
            const form = document.getElementById('creaViaggioForm');
            let formData = new FormData(form);
            const viaggioDTO = {
                nome: document.getElementById('nome').value,
                luogoPartenza: document.getElementById('luogoPartenza').value,
                luogoArrivo: document.getElementById('luogoArrivo').value,
                dataPartenza: document.getElementById('dataPartenza').value,
                dataRitorno: document.getElementById('dataRitorno').value,
                dataScadenza: document.getElementById('dataScadenza').value,
                numPartMin: document.getElementById('numPartMin').value,
                numPartMax: document.getElementById('numPartMax').value,
                prezzo: document.getElementById('prezzo').value,
                etaMin: document.getElementById('etaMin').value,
                etaMax: document.getElementById('etaMax').value,
                tags: getSelectedTags()
            };

            formData.append('viaggioDTO', new Blob([JSON.stringify(viaggioDTO)], { type: 'application/json' }));
            const immagineCopertina = document.getElementById('immagineCopertina').files[0];
            if (immagineCopertina) {
                formData.append('immagineCopertina', immagineCopertina);
            }
            const immagini = document.getElementById('immagini').files;
            for (let i = 0; i < immagini.length; i++) {
                formData.append('immagini', immagini[i]);
            }
            inviaDati(formData);
        }

        // Funzione per inviare i dati tramite fetch
        function inviaDati(formData) {
            fetch('/api/viaggi/crea', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    return response.text().then(text => { throw new Error(text) });
                }
            })
            .then(data => {
                console.log("Viaggio creato con successo:", data);
                mostraFeedback(true);
            })
            .catch(error => {
                console.error('Errore:', error.message);
                mostraFeedback(false);
            });
        }

        // Funzione per raccogliere i tag selezionati
        function getSelectedTags() {
            const selectedTagsDiv = document.getElementById('selectedTags');
            const tagElements = selectedTagsDiv.getElementsByClassName('tag');
            const selectedTags = [];
            for (let tagElement of tagElements) {
                const tagId = tagElement.getAttribute('data-tag-id');
                const tipoTag = tagElement.textContent;
                if (tagId && tipoTag) {
                    selectedTags.push({ tagId: tagId, tipoTag: tipoTag });
                }
            }
            console.log("Tag selezionati:", selectedTags);
            return selectedTags;
        }

        // Inizializza la pagina caricando i tag
        getTags().then(displayTags);
    </script>
    <style>
        #availableTags, #selectedTags {
            width: 45%;
            float: left;
            border: 1px solid black;
            min-height: 100px;
            padding: 10px;
            margin: 10px;
        }
        .tag {
            display: inline-block;
            padding: 10px;
            margin: 5px;
            background-color: lightblue;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        .img-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            margin-right: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Creazione di un nuovo viaggio</h1>
    <form id="creaViaggioForm" enctype="multipart/form-data" onsubmit="event.preventDefault(); inviaForm();">
        <label for="nome">Nome del Viaggio:</label>
        <input type="text" id="nome" name="nome" required><br><br>

        <label for="luogoPartenza">Luogo di Partenza:</label>
        <input type="text" id="luogoPartenza" name="luogoPartenza" required><br><br>

        <label for="luogoArrivo">Luogo di Arrivo:</label>
        <input type="text" id="luogoArrivo" name="luogoArrivo" required><br><br>

        <label for="dataPartenza">Data di Partenza:</label>
        <input type="date" id="dataPartenza" name="dataPartenza" required><br><br>

        <label for="dataRitorno">Data di Ritorno:</label>
        <input type="date" id="dataRitorno" name="dataRitorno" required><br><br>

        <label for="dataScadenza">Data di Scadenza Iscrizione:</label>
        <input type="date" id="dataScadenza" name="dataScadenza" required><br><br>

        <label for="numPartMin">Numero di Partecipanti Minimo:</label>
        <input type="number" id="numPartMin" name="numPartMin" required><br><br>

        <label for="numPartMax">Numero di Partecipanti Massimo:</label>
        <input type="number" id="numPartMax" name="numPartMax" required><br><br>

        <label for="prezzo">Prezzo (€):</label>
        <input type="number" step="0.01" id="prezzo" name="prezzo" required><br><br>

        <label for="etaMin">Età Minima:</label>
        <input type="number" id="etaMin" name="etaMin" required><br><br>

        <label for="etaMax">Età Massima:</label>
        <input type="number" id="etaMax" name="etaMax" required><br><br>

        <!-- Selezione Tag -->
        <h3>Seleziona i tuoi tag</h3>
        <div id="availableTags">
            <h4>Tag disponibili</h4>
        </div>
        <div id="selectedTags">
            <h4>Tag selezionati</h4>
        </div>

        <label for="immagineCopertina">Immagine Copertina del Viaggio:</label>
        <input type="file" id="immagineCopertina" name="immagineCopertina" accept="image/*"><br><br>
        <div id="copertinaPreview"></div>

        <!-- Sezione per il caricamento di più immagini -->
        <label for="immagini">Altre Immagini del Viaggio:</label>
        <input type="file" id="immagini" name="immagini" accept="image/*" multiple onchange="handleMultipleImages()"><br><br>

        <!-- Anteprima delle immagini selezionate -->
        <div id="previewContainer"></div>

        <input type="submit" value="Crea Viaggio">
    </form>
    
    <p id="feedback"></p>
</body>
</html>