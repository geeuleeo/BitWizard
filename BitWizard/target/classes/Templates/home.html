<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Home</title>
</head>
<body>
    <h1>Benvenuto, <span th:text="${nomeUtente}">Utente</span>!</h1>
    
    <button id="pulsanteLogin" onclick="location.href='/login'">Vai al Login</button>
    <button id="pulsanteLogout" onclick="effettuaLogout()">Logout</button>

    <title>Filtra Viaggi</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
            background-color: #f4f4f4;
        }
        h1 {
            color: #333;
        }
        form {
            margin-bottom: 20px;
        }
        input, select {
            margin-right: 10px;
        }
        .results {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #fff;
        }
    </style>
    </head>

    <div id="utenteId" th:text="${idUtente} "></div>
    <div id="tagUtente" th:text="${tagsUtente}"></div>


    <h1>Filtra i tuoi Viaggi</h1>


    <form id="filterByTag">
        <h2>Filtra per Tag</h2>
        <label for="tagId">Tag ID:</label>
        <input type="number" id="tagId" required>
        <button type="submit">Cerca</button>
    </form>


    <form id="filterByAge">
        <h2>Filtra per Età</h2>
        <label for="minAge">Età Minima:</label>
        <input type="number" id="minAge" required>
        <label for="maxAge">Età Massima:</label>
        <input type="number" id="maxAge" required>
        <button type="submit">Cerca</button>
    </form>


    <form id="filterByDestination">
        <h2>Filtra per Destinazione</h2>
        <label for="destinazione">Destinazione:</label>
        <input type="text" id="destinazione" required>
        <button type="submit">Cerca</button>
    </form>


    <form id="filterByPartenza">
        <h2>Filtra per Partenza</h2>
        <label for="partenza">Partenza:</label>
        <input type="text" id="partenza" required>
        <button type="submit">Cerca</button>
    </form>


    <form id="filterByPrezzo">
        <h2>Filtra per Prezzo</h2>
        <label for="minPrezzo">Prezzo Minimo:</label>
        <input type="number" id="minPrezzo" required>
        <label for="maxPrezzo">Prezzo Massimo:</label>
        <input type="number" id="maxPrezzo" required>
        <button type="submit">Cerca</button>
    </form>

    <div class="results" id="results"></div>
    <div class="consigliati" id="consigliati"></div>

	<button onclick="location.href='/lista'">Vai alla Lista di Viaggi</button>
	
	<button id="pulsanteCreaViaggio" onclick="location.href='/CreaViaggio'">Crea il tuo Viaggio</button>

    <script>

    async function fetchData(url) {
    const response = await fetch(url);

    if (!response.ok) {
    const errorText = await response.text();
    throw new Error(errorText);
    }

    return await response.json();
    }

    document.getElementById('filterByTag').addEventListener('submit', async (e) => {
    e.preventDefault();

    const tagId = document.getElementById('tagId').value;

    try {
    const result = await fetchData(`api/viaggi/filtra/tag?tagId=${tagId}`);
    document.getElementById('results').innerText = JSON.stringify(result);
    } catch (error) {
    document.getElementById('results').innerText = error.message;
    }
    });




        document.getElementById('filterByAge').addEventListener('submit', async (e) => {
            e.preventDefault();

            const minAge = document.getElementById('minAge').value;
            const maxAge = document.getElementById('maxAge').value;

            try {
                const result = await fetchData(`api/viaggi/filtra/eta?min=${minAge}&max=${maxAge}`);
                document.getElementById('results').innerText = JSON.stringify(result);
            } catch (error) {
                document.getElementById('results').innerText = error.message;
            }
        });

        document.getElementById('filterByDestination').addEventListener('submit', async (e) => {
            e.preventDefault();

            const destinazione = document.getElementById('destinazione').value;

            try {
                const result = await fetchData(`api/viaggi/filtra/destinazione?destinazione=${destinazione}`);
                document.getElementById('results').innerText = JSON.stringify(result);
            } catch (error) {
                document.getElementById('results').innerText = error.message;
            }
        });

        document.getElementById('filterByPartenza').addEventListener('submit', async (e) => {
            e.preventDefault();

            const partenza = document.getElementById('partenza').value;

            try {
                const result = await fetchData(`api/viaggi/filtra/partenza?partenza=${partenza}`);
                document.getElementById('results').innerText = JSON.stringify(result);
            } catch (error) {
                document.getElementById('results').innerText = error.message;
            }
        });

        document.getElementById('filterByPrezzo').addEventListener('submit', async (e) => {
            e.preventDefault();

            const minPrezzo = document.getElementById('minPrezzo').value;
            const maxPrezzo = document.getElementById('maxPrezzo').value;

            try {
                const result = await fetchData(`api/viaggi/filtra/prezzo?min=${minPrezzo}&max=${maxPrezzo}`);
                document.getElementById('results').innerText = JSON.stringify(result);
            } catch (error) {
                document.getElementById('results').innerText = error.message;
            }
        });



    async function getTags() {
        try {
            const response = await fetch('/api/tags/get', {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            // Controlla se la risposta è ok
            if (response.ok) {
                const tags = await response.json(); N


                if (tags.length > 0) {

                    const tagIds = tags.map(tag => tag.tagId);

                    const randomId = tagIds[Math.floor(Math.random() * tagIds.length)];


                    const viaggiResponse = await fetch(`/api/viaggi/filtra/tag?tagId=${randomId}`, {
                        method: 'GET',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (viaggiResponse.ok) {
                        const viaggi = await viaggiResponse.json();


                        const consigliatiDiv = document.getElementById('consigliati');
                        consigliatiDiv.innerHTML = '';


                        const risultatiDaMostrare = viaggi.slice(0, 3);
                        risultatiDaMostrare.forEach(viaggio => {
                            const viaggioElement = document.createElement('div');
                            viaggioElement.textContent = viaggio.nome + "// luogo partenza = "+viaggio.luogoPartenza+"//luogo arrivo = "+ viaggio.luogoArrivo;
                            consigliatiDiv.appendChild(viaggioElement);
                        });
                    } else {
                        console.error('Errore durante il recupero dei viaggi:', viaggiResponse.status);
                    }
                } else {
                    console.error('Nessun tag trovato');
                }
            }
        } catch (error) {
            console.error('Errore durante la fetch:', error);
        }
    }
    
    async function bottoneLogin() {
        try {
            // Effettua la richiesta al server per ottenere l'ID dell'utente loggato
            const response = await fetch(`/api/utente/session`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                const utenteLoggato = await response.json(); // Ottieni l'ID dell'utente loggato dal server

                console.log('ID utente loggato:', utenteLoggato);

                if (utenteLoggato) {
                    // Nascondi il pulsante di login
                    document.getElementById('pulsanteLogin').style.display = 'none';

                    // Mostra il pulsante di logout
                    document.getElementById('pulsanteLogout').style.display = 'block';
                    
                    document.getElementById('pulsanteCreaViaggio').style.display = 'block';
                } else {
                    // Mostra il pulsante di login
                    document.getElementById('pulsanteLogin').style.display = 'block';

                    // Nascondi il pulsante di logout
                    document.getElementById('pulsanteLogout').style.display = 'none';
                    
                    document.getElementById('pulsanteCreaViaggio').style.display = 'none';
                }
            } else {
                console.error('Errore nel recupero della sessione utente');
             // Mostra il pulsante di login
                document.getElementById('pulsanteLogin').style.display = 'block';

                // Nascondi il pulsante di logout
                document.getElementById('pulsanteLogout').style.display = 'none';
                
                document.getElementById('pulsanteCreaViaggio').style.display = 'none';
            }
        } catch (error) {
            console.error('Errore durante la richiesta:', error);
        }
    }
    
    async function effettuaLogout() {
        try {
            const response = await fetch('/logout', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                const message = await response.text(); // Ottieni il messaggio di risposta dal server
                alert(message); // Mostra il messaggio di logout effettuato con successo
                window.location.href = '/';
            } else {
                alert('Errore durante il logout. Riprova.');
            }
        } catch (error) {
            console.error('Errore durante la richiesta di logout:', error);
        }
    }

	bottoneLogin();

    getTags();
    
    </script>

</body>
</html>